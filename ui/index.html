<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8" />
	<title>Life-Agent Dashboard</title>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<style>
		body{font-family:system-ui,Arial,sans-serif;margin:0;background:#0f1115;color:#eee;}
		main{max-width:1400px;margin:0 auto;}
		p,li{overflow-wrap:anywhere;}
		pre{white-space:pre-wrap;word-break:break-word;}
		header{padding:12px 20px;background:#1b1f27;display:flex;align-items:center;gap:16px;}
		h1{font-size:18px;margin:0;}
		#tabsBar{display:flex;gap:4px;flex-wrap:wrap;padding:8px 14px;background:#14181f;border-bottom:1px solid #252b33;}
		#tabsBar button{background:#25303c;color:#cfd8e3;border:1px solid #2f3a45;border-radius:6px;padding:6px 10px;font-size:13px;cursor:pointer;}
		#tabsBar button.active{background:#2563eb;color:#fff;border-color:#2563eb;}
		main{padding:14px;}
		.tabSection{display:none;}
		.tabSection.active{display:flex;flex-direction:column;gap:12px;}
		section.panel{background:#1d222b;border:1px solid #2b313c;border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px;min-width:0;}
		section.panel h2{font-size:15px;margin:0 0 4px;font-weight:600;color:#9bd2ff;display:flex;align-items:center;gap:8px;}
		button{cursor:pointer;background:#2563eb;color:#fff;border:0;border-radius:4px;padding:6px 10px;font-size:13px;display:inline-flex;align-items:center;gap:6px;}
		button.secondary{background:#374151;}
		button:disabled{opacity:.4;cursor:not-allowed;}
		input,textarea,select{width:100%;background:#11161c;color:#eee;border:1px solid #2e3a45;border-radius:4px;padding:6px;font-family:inherit;font-size:13px;}
		textarea{min-height:90px;resize:vertical;}
		code,pre{background:#11161c;color:#d1e7ff;font-size:12px;line-height:1.4;border:1px solid #2b313c;border-radius:4px;padding:8px;white-space:pre-wrap;word-break:break-word;max-height:260px;overflow:auto;margin:0;}
		.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
		.pill{background:#243244;padding:2px 8px;border-radius:999px;font-size:11px;color:#9fbcd9;border:1px solid #324556;}
		footer{padding:10px 16px;font-size:12px;color:#7b8793;text-align:center;border-top:1px solid #2b313c;margin-top:8px;}
		a{color:#70b8ff;text-decoration:none;}a:hover{text-decoration:underline;}
		.badge{background:#2c3650;padding:2px 6px;border-radius:6px;font-size:11px;color:#bcd;}
		.category-badge{padding:2px 6px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
		.cat-risk{background:#3a1214;color:#f87171;border:1px solid #803036;}
		.cat-opportunity{background:#12391d;color:#4ade80;border:1px solid #2f6c43;}
		.cat-action{background:#122b3a;color:#38bdf8;border:1px solid #1d4d63;}
		.cat-system{background:#27272a;color:#d4d4d8;border:1px solid #3f3f46;}
		.cat-neutral{background:#2c2f36;color:#9ca3af;border:1px solid #383e46;}
		#suggestList button{font-size:11px;}
		.small{font-size:11px;opacity:.75;}
		/* Diff styling */
		#suggestPatchNav{display:flex;flex-wrap:wrap;gap:4px;margin:4px 0;}
		#suggestPatchNav a{background:#25303c;color:#cbd5e1;text-decoration:none;font-size:11px;padding:2px 6px;border-radius:4px;border:1px solid #2f3a45;}
		#suggestPatchNav a:hover{background:#2563eb;color:#fff;}
		.diff-container{background:#0f1419;border:1px solid #2b313c;border-radius:6px;padding:6px;max-height:300px;overflow:auto;font-family:ui-monospace,monospace;font-size:12px;line-height:1.35;}
		.diff-line{display:block;white-space:pre;}
		.diff-file{background:#1e293b;color:#f1f5f9;font-weight:600;border-top:1px solid #334155;padding:2px 4px;margin:2px -4px 2px -4px;}
		.diff-hunk{background:#243244;color:#9bd2ff;font-weight:600;padding:2px 4px;margin:2px -4px;}
		.diff-add{background:#062a18;color:#b6f3ce;}
		.diff-del{background:#3a1214;color:#fda4af;}
		.diff-context{color:#cbd5e1;}
		.diff-line .ln{display:inline-block;width:70px;opacity:.55;color:#94a3b8;}
		.diff-line.highlight{outline:1px solid #facc15;background:linear-gradient(90deg,#423511,#3a2f13);}
		#suggestPatchOut{background:transparent;border:0;padding:0;}
		#errorSummary{display:none;background:#3a1214;border:1px solid #803036;color:#fca5a5;padding:8px;border-radius:6px;font-size:12px;line-height:1.35;}
		.errorField{border-color:#f87171 !important;background:#2b1113 !important;}
		.microcopy{font-size:11px;opacity:.65;margin-top:2px;}
	</style>
</head>
<body>
	<header>
		<h1>Life-Agent Dashboard</h1>
		<div class="row" style="margin-left:auto;">
			<input id="apiKey" placeholder="API Key" value="test" style="width:160px;" title="Wird lokal im Browser gespeichert (localStorage)." />
			<span id="apiKeyStatus" class="pill">key?</span>
			<span id="badgeMeta" class="pill">meta: -</span>
			<span id="badgeLLM" class="pill">llm: -</span>
			<span id="badgePolicy" class="pill">policy: -</span>
			<button id="btnMeta">Meta</button>
			<button id="btnLLM">LLM Status</button>
			<button id="btnMetrics" class="secondary">Metrics</button>
			<button id="btnEvents" class="secondary">Events</button>
		</div>
	</header>
	<div id="tabsBar"></div>
	<main>
		<div id="errorSummary" aria-live="polite"></div>
		<div id="tab-uebersicht" class="tabSection active">
			<section class="panel">
			<h2>Übersicht</h2>
			<div id="onboarding" style="background:#13202c;border:1px solid #27323d;padding:10px;border-radius:6px;line-height:1.4;font-size:12px;display:flex;flex-direction:column;gap:6px;">
				<strong>Erste Schritte</strong>
				<ol style="margin:0 0 0 18px;padding:0;display:flex;flex-direction:column;gap:4px;">
					<li>API Key oben setzen (persistiert lokal).</li>
					<li>LLM Status prüfen &gt; Falls OFF: <code>GROQ_API_KEY</code> setzen und Server neu starten.</li>
					<li>Plane Änderung: Intent + Pfade eingeben &rarr; "Plan erstellen".</li>
					<li>Variante auswählen, Details prüfen (Patch Vorschau).</li>
					<li>Suggestion Workflow: Tab "Vorschläge" nutzen (Generieren, Genehmigen, Verfeinern).</li>
					<li>Story erleben: Tab "Spiel" oder separate <a href="/story/ui" target="_blank">Story UI</a>.</li>
					<li>Richtlinie anpassen: Tab "Richtlinien" &rarr; Laden, Bearbeiten, Validieren, Anwenden.</li>
					<li>Beobachte Metriken & Events für Telemetrie.</li>
				</ol>
				<div style="display:flex;gap:8px;flex-wrap:wrap;">
					<span class="pill" style="background:#203042;">Onboarding</span>
					<span class="pill" style="background:#203422;">Flow</span>
					<span class="pill" style="background:#342022;">LLM</span>
				</div>
			</div>
			<div class="row">
				<span class="pill" id="metaVersion">ver...</span>
				<span class="pill" id="metaUptime">uptime...</span>
				<span class="pill" id="llmConfig">llm...</span>
			</div>
			<pre id="metaOut">Meta Output...</pre>
			<pre id="llmOut">LLM Output...</pre>
			</section>
		</div>
		<div id="tab-plan" class="tabSection">
			<section class="panel">
			<h2>Plan</h2>
			<input id="planIntent" placeholder="Intent / Ziel" value="demo" />
			<div class="microcopy" id="planIntentHelp">Kurz und prägnant formulieren (z.B. "Logging verbessern" oder "Neuen Endpunkt für /health hinzufügen").</div>
			<textarea id="planContext" placeholder="Kontext">kurzer test</textarea>
			<input id="planTargets" placeholder="Dateipfade (Komma)" value="api/app.py" />
			<div class="microcopy" id="planTargetsHelp">Kommagetrennte relative Pfade (Whitelist enforced). Beispiel: <code>api/app.py,policy/model.py</code></div>
			<div class="row">
				<select id="riskBudget" style="flex:1;min-width:120px;">
					<option value="">Risiko (auto)</option>
					<option value="low">Niedrig</option>
					<option value="medium">Mittel</option>
					<option value="high">Hoch</option>
				</select>
				<button id="btnPlan">Plan erstellen</button>
				<button id="btnPlanPR" class="secondary">PR aus Plan</button>
			</div>
			<div id="variantSliderWrap" style="display:none;flex-direction:column;gap:4px;margin:6px 0;">
				<label style="font-size:11px;display:flex;justify-content:space-between;align-items:center;">Variante wählen
					<span id="variantSliderLabel" class="pill">-</span></label>
				<input type="range" id="variantSlider" min="0" max="0" value="0" step="1" />
			</div>
			<div id="prModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:500;">
				<div style="background:#1d222b;padding:16px;border:1px solid #2b313c;border-radius:8px;width:360px;display:flex;flex-direction:column;gap:8px;">
					<h3 style="margin:0;font-size:15px;">PR aus Plan</h3>
					<input id="prBranch" placeholder="Branch (auto)" />
					<input id="prVariant" placeholder="Variant ID (leer = erste)" />
					<label style="font-size:11px;display:flex;align-items:center;gap:6px;"><input type="checkbox" id="prDry" /> Dry Run</label>
					<div class="row" style="justify-content:flex-end;">
						<button id="prCancel" class="secondary">Abbrechen</button>
						<button id="prRun">Ausführen</button>
					</div>
					<pre id="prOut" style="max-height:140px;overflow:auto;">PR Output...</pre>
				</div>
			</div>
			<div id="variantList" style="display:flex;flex-direction:column;gap:6px;max-height:140px;overflow:auto;border:1px solid #2b313c;padding:6px;border-radius:6px;background:#151a20;">
				<em style="font-size:12px;color:#667">Noch keine Varianten geladen.</em>
			</div>
			<pre id="planVariantDetail">Variant Detail...</pre>
			<pre id="planOut">Raw Plan Output...</pre>
			</section>
		</div>
		<div id="tab-chat" class="tabSection">
			<section class="panel">
			<h2>Chat</h2>
			<div class="row">
				<select id="persona" style="flex:1;min-width:110px;">
					<option value="">Persona: Standard</option>
					<option value="mentor">mentor</option>
					<option value="auditor">auditor</option>
					<option value="architekt">architekt</option>
					<option value="erzähler">erzähler</option>
				</select>
				<input id="agentId" placeholder="Agent ID (optional)" style="width:140px;" />
				<button id="btnChat">Senden</button>
				<span id="chatInfo" class="pill">not configured</span>
			</div>
			<textarea id="chatPrompt" placeholder="Nachricht">Sag kurz Hallo.</textarea>
			<pre id="chatOut">Chat Output...</pre>
			</section>
		</div>
		<div id="tab-events" class="tabSection">
			<section class="panel">
			<h2>Ereignisse & Metriken</h2>
			<div class="row">
				<span id="eventsState" class="pill">events: idle</span>
				<span id="metricsState" class="pill">metrics: idle</span>
				<input id="eventsFilter" placeholder="filter regex" style="flex:1;min-width:120px;" />
				<button id="btnFilterClear" class="secondary">X</button>
			</div>
			<pre id="eventsOut">Events...</pre>
			<pre id="metricsOut">Metrics...</pre>
			</section>
		</div>
		<div id="tab-policy" class="tabSection">
			<section class="panel">
			<h2>Richtlinien</h2>
			<div class="row">
				<button id="btnPolicyLoad" class="secondary">Laden</button>
				<button id="btnPolicyValidate">Prüfen</button>
				<button id="btnPolicyApply">Anwenden</button>
				<span id="policyStatus" class="pill">policy: ?</span>
			</div>
			<textarea id="policyContent" placeholder="YAML policy..." spellcheck="false"></textarea>
			<div class="microcopy">Nutze "Prüfen" für schnellen Dry-Run (<code>/policy/dry-run</code>). Erst bei Erfolg "Anwenden".</div>
			<pre id="policyOut">Policy Output...</pre>
			</section>
		</div>
		<div id="tab-memory" class="tabSection">
			<section class="panel">
			<h2>Gedächtnis</h2>
			<div class="row"><button id="btnMemRefresh" class="secondary">Aktualisieren</button><span id="memInfo" class="pill">-</span></div>
			<pre id="memoryOut">Memory...</pre>
			</section>
		</div>
		<div id="tab-quests" class="tabSection">
			<section class="panel">
			<h2>Quests</h2>
			<div class="row">
				<input id="questTheme" placeholder="Thema" style="flex:1;" />
				<select id="questDifficulty">
					<option value="easy">leicht</option>
					<option value="normal" selected>normal</option>
					<option value="hard">schwer</option>
				</select>
				<button id="btnQuestGen">Erzeugen</button>
			</div>
			<div class="row"><button id="btnQuestList" class="secondary">Aktualisieren</button></div>
			<pre id="questOut">Quests...</pre>
			</section>
		</div>
		<div id="tab-vorschlaege" class="tabSection">
			<section class="panel">
			<h2>Vorschläge <span id="suggestOpenBadge" class="badge">open: ?</span></h2>
			<div class="row">
				<button id="btnSuggestList" class="secondary">Aktualisieren</button>
				<button id="btnSuggestGen">Generieren</button>
				<button id="btnSuggestAuto" class="secondary">Auto</button>
				<input id="suggestId" placeholder="ID" style="flex:1;" />
			</div>
			<div class="row">
				<button id="btnSuggestLoad" class="secondary">Laden</button>
				<button id="btnSuggestApprove" class="secondary">Genehmigen</button>
				<button id="btnSuggestRevise" class="secondary">Überarbeiten</button>
				<button id="btnSuggestRefine" class="secondary">Verfeinern (LLM)</button>
			</div>
			<div class="row">
				<button id="btnSuggestDownload" class="secondary">JSON</button>
				<button id="btnSuggestCopyPatch" class="secondary">Patch kopieren</button>
				<button id="btnSuggestChunks" class="secondary">Diff Teile</button>
			</div>
			<input id="suggestGoal" placeholder="Ziel" value="Test Abdeckung verbessern" />
			<input id="suggestFocus" placeholder="Fokus Pfade (Komma)" />
			<textarea id="suggestAdjust" placeholder="Anpassungen / Hinweise" style="min-height:60px;"></textarea>
			<div class="row"><input id="patchSearch" placeholder="Patch Suche (Regex)" style="flex:1;" /></div>
			<div id="suggestList" style="display:flex;flex-direction:column;gap:4px;max-height:120px;overflow:auto;border:1px solid #2b313c;padding:6px;border-radius:6px;background:#151a20;font-size:12px;"><em style="color:#667">Liste leer – Refresh.</em></div>
			<pre id="suggestImpactOut">Impact...</pre>
			<pre id="suggestOut">Suggestion Output...</pre>
			<div id="suggestPatchNav" class="small">Diff Navigation...</div>
			<div id="suggestPatchOut" class="diff-container">Patch Output...</div>
			<pre id="suggestChunksOut">Chunks...</pre>
			</section>
		</div>
		<div id="tab-gedanken" class="tabSection">
			<section class="panel">
			<h2>Gedanken</h2>
			<div class="row">
				<button id="btnThoughtRefresh" class="secondary">Aktualisieren</button>
				<button id="btnThoughtGen" class="secondary">Jetzt erzeugen</button>
				<span id="thoughtInfo" class="pill">-</span>
			</div>
			<pre id="thoughtOut">Gedanken...</pre>
			</section>
		</div>
		<div id="tab-game" class="tabSection">
			<section class="panel">
			<h2>Spiel</h2>
			<div class="row">
				<button id="btnIdleState" class="secondary">Status</button>
				<button id="btnIdleTick">Tick</button>
				<span id="idleInfo" class="pill">tick: -</span>
			</div>
			<pre id="idleOut">Idle State...</pre>
			</section>
		</div>
	</main>
	<footer>
		&copy; Life-Agent Dev • <a href="/docs" target="_blank">OpenAPI Docs</a> • <a href="/static-docs/openapi.yaml" target="_blank">Spec (YAML)</a>
	</footer>
	<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
	<script>
		const $ = sel => document.querySelector(sel);
		const api = (path, opts={}) => {
			const key = $('#apiKey').value.trim();
			const headers = Object.assign({'X-API-Key': key}, opts.headers||{});
			return fetch(path, {...opts, headers}).then(r => r.json().catch(()=>({error:'non-json', status:r.status})));
		};
		// Tabs setup
		const TABS = [
			['uebersicht','Übersicht'],
			['plan','Plan'],
			['chat','Chat'],
			['vorschlaege','Vorschläge'],
			['quests','Quests'],
			['memory','Gedächtnis'],
			['gedanken','Gedanken'],
			['events','Events'],
			['policy','Richtlinien'],
			['game','Spiel']
		];
		function buildTabs(){
			const bar = $('#tabsBar');
			bar.innerHTML='';
			TABS.forEach(([id,label])=>{
				const btn=document.createElement('button');
				btn.textContent=label; btn.dataset.tab=id;
				btn.onclick=()=>activateTab(id);
				bar.appendChild(btn);
			});
			activateTab('uebersicht');
		}
		function activateTab(id){
			[...document.querySelectorAll('#tabsBar button')].forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
			[...document.querySelectorAll('.tabSection')].forEach(sec=>sec.classList.toggle('active', sec.id==='tab-'+id));
		}
		function updateApiKeyStatus(){
			const key=$('#apiKey').value.trim();
			const pill=$('#apiKeyStatus');
			if(!pill) return;
			if(key){pill.textContent='KEY OK'; pill.style.background='#1f3b2b'; pill.style.color='#6ee7b7';}
			else {pill.textContent='NO KEY'; pill.style.background='#402727'; pill.style.color='#fca5a5';}
		}
		function loadStoredKey(){
			try{const k=localStorage.getItem('life_agent_api_key'); if(k){$('#apiKey').value=k;}}catch{}
			updateApiKeyStatus();
		}
		$('#apiKey').addEventListener('input', ()=>{
			try{localStorage.setItem('life_agent_api_key',$('#apiKey').value);}catch{}
			updateApiKeyStatus();
		});
		function fmt(obj){try{return JSON.stringify(obj,null,2);}catch{return String(obj)}}
		function setText(id,content){const el=$(id); if(el) el.textContent=content;}
		function setBadge(el, ok){ if(!el) return; el.style.background = ok? '#1f3b2b':'#402727'; el.style.color = ok? '#6ee7b7':'#fca5a5'; }

		// Local metrics (client only) helper
		function emitLocalMetric(kind,payload){
			console.log('[metric]',kind,payload);
			if(kind==='variant.selected'){
				let badge=document.getElementById('variantMetricBadge');
				if(!badge){
					badge=document.createElement('span');
					badge.id='variantMetricBadge';
					badge.className='pill';
					const headerRow=document.querySelector('header .row');
					if(headerRow){ headerRow.appendChild(badge); }
				}
				badge.textContent='variant: '+payload.label;
				badge.style.background='#203042';
			}
		}

		// ---- Error Handling Helpers ----
		const _errors=[];
		function clearErrors(){
			_errors.length=0;
			const sum=$('#errorSummary');
			if(sum){ sum.style.display='none'; sum.innerHTML=''; }
			document.querySelectorAll('.errorField').forEach(el=>{el.classList.remove('errorField'); el.removeAttribute('aria-invalid');});
		}
		function addError(fieldId,message){
			_errors.push({field:fieldId,message});
			const el=document.getElementById(fieldId);
			if(el){ el.classList.add('errorField'); el.setAttribute('aria-invalid','true'); }
		}
		function renderErrors(){
			if(!_errors.length) return;
			const sum=$('#errorSummary'); if(!sum) return;
			sum.innerHTML='<strong>Fehler ('+_errors.length+')</strong><ul style="margin:4px 0 0 16px;padding:0;">'+_errors.map(e=>'<li><a style="color:#fca5a5;" href="#'+e.field+'">'+e.message+'</a></li>').join('')+'</ul>';
			sum.style.display='block';
		}

		async function loadMeta(){
			const meta = await api('/meta');
			setText('#metaOut', fmt(meta));
			if(meta.meta){
				$('#metaVersion').textContent = 'v ' + (meta.meta.version||'?');
				$('#metaUptime').textContent = 'up ' + ((meta.uptime||0).toFixed? meta.uptime.toFixed(1): meta.uptime);
				setText('#badgeMeta','meta: ok'); setBadge($('#badgeMeta'), true);
			} else { setText('#badgeMeta','meta: err'); setBadge($('#badgeMeta'), false); }
		}
		async function loadLLM(){
			const s = await api('/llm/status');
			setText('#llmOut', fmt(s));
			$('#llmConfig').textContent = s.configured? 'LLM ON':'LLM OFF';
			$('#chatInfo').textContent = s.configured? 'configured':'not configured';
			setText('#badgeLLM', 'llm: '+(s.configured? 'on':'off')); setBadge($('#badgeLLM'), s.configured);
		}
		function renderVariants(r){
			const box = $('#variantList');
			box.innerHTML='';
			if(!r || !Array.isArray(r.variants) || !r.variants.length){
				box.innerHTML='<em style="font-size:12px;color:#667">Keine Varianten.</em>';
				return;
			}
			// attach to slider
			const sliderWrap=$('#variantSliderWrap'); const slider=$('#variantSlider'); const lab=$('#variantSliderLabel');
			if(slider){ slider.max=String(r.variants.length-1); slider.value='0'; sliderWrap.style.display='flex'; }
			function applyVariant(ix){
				const v=r.variants[ix]; if(!v) return; lab.textContent=v.label; setText('#planVariantDetail', fmt({id:v.id,label:v.label,risk_level:v.risk_level,knobs:v.knobs,summary:v.summary,explanation:v.explanation,patch_preview:v.patch_preview})); $('#prVariant').value=v.id; emitLocalMetric('variant.selected',{id:v.id,label:v.label,risk:v.risk_level}); }
			if(slider){ slider.oninput=()=>applyVariant(parseInt(slider.value)); }
			r.variants.forEach(v=>{
				const btn=document.createElement('button');
				btn.className='secondary';
				btn.style.justifyContent='space-between';
				btn.style.display='flex';
				btn.style.width='100%';
				btn.textContent=`${v.label} · depth=${v.knobs?.depth_limit} · risk=${v.knobs?.risk_budget}`;
				btn.onclick=()=>{
					const detail = {
						id:v.id,
						label:v.label,
						risk_level:v.risk_level,
						knobs:v.knobs,
						summary:v.summary,
						explanation:v.explanation,
						patch_preview:v.patch_preview
					};
					setText('#planVariantDetail', fmt(detail));
					$('#prVariant').value = v.id;
				};
				box.appendChild(btn);
			});
			applyVariant(0);
		}
		// PR Modal logic
		$('#btnPlanPR').onclick=()=>{ $('#prModal').style.display='flex'; };
		$('#prCancel').onclick=()=>{ $('#prModal').style.display='none'; };
		$('#prRun').onclick=async()=>{
			const intent=$('#planIntent').value.trim(); if(!intent){ alert('Intent erforderlich'); return; }
			const variantId=$('#prVariant').value.trim();
			const branch=$('#prBranch').value.trim();
			const dry=$('#prDry').checked;
			const body={intent, variant_id: variantId||undefined, branch: branch||undefined, dry_run: dry};
			const r=await api('/dev/pr-from-plan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
			setText('#prOut', fmt(r));
			if(r.status==='created' || r.status==='dry-run'){ $('#prModal').style.display='none'; }
		};
		async function runPlan(){
			clearErrors();
			const intentRaw=$('#planIntent').value.trim();
			if(!intentRaw){ addError('planIntent','Intent erforderlich'); }
			const targetsRaw=$('#planTargets').value.trim();
			if(!targetsRaw){ addError('planTargets','Mindestens ein Dateipfad erforderlich'); }
			if(_errors.length){ renderErrors(); return; }
			const body = {
				intent: intentRaw,
				context: $('#planContext').value,
				target_paths: $('#planTargets').value.split(',').map(s=>s.trim()).filter(Boolean)
			};
			const rb = $('#riskBudget').value;
			const url = rb? `/plan?risk_budget=${encodeURIComponent(rb)}` : '/plan';
			const r = await api(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
			setText('#planOut', fmt(r));
			renderVariants(r);
			if(r.variants && r.variants[0]){
				setText('#planVariantDetail', fmt(r.variants[0]));
			}
		}
		async function runChat(){ const persona=$('#persona').value||undefined; const agentId=$('#agentId').value.trim()||undefined; const body={messages:[{role:'user',content:$('#chatPrompt').value}], persona, agent_id:agentId}; const r=await api('/llm/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#chatOut', fmt(r)); refreshMemory(); }
		let evtSrc=null;
		function startEvents(){
			if(evtSrc){evtSrc.close();}
			$('#eventsState').textContent='events: connecting';
			const key=$('#apiKey').value.trim();
			evtSrc = new EventSource('/events?token='+encodeURIComponent(key));
			evtSrc.onopen=()=>$('#eventsState').textContent='events: open';
			evtSrc.onmessage=e=>{ 
				const pre=$('#eventsOut'); 
				let filter=$('#eventsFilter').value.trim();
				if(filter){
					try{const re=new RegExp(filter,'i'); if(!re.test(e.data)) return;}catch{}
				}
				pre.textContent += '\n'+e.data; pre.scrollTop=pre.scrollHeight; 
				if(e.data.includes('suggest.open')){ const m=e.data.match(/"open":\s*(\d+)/); if(m) updateOpenBadge(parseInt(m[1])); }
				if(e.data.includes('thought.stream')){ refreshThoughts(); }
				if(e.data.includes('idle.tick.auto')){ try{ const m=e.data.match(/"tick":\s*(\d+)/); if(m){ $('#idleInfo').textContent='auto tick: '+m[1]; } }catch{} }
			};
			evtSrc.onerror=()=>$('#eventsState').textContent='events: error';
		}
		$('#btnFilterClear').onclick=()=>{ $('#eventsFilter').value=''; };
		async function loadMetrics(){
			$('#metricsState').textContent='metrics: loading';
			const key=$('#apiKey').value.trim();
			const r = await fetch('/metrics',{headers:{'X-API-Key':key}});
			const txt = await r.text();
			$('#metricsOut').textContent = txt.split('\n').slice(0,80).join('\n');
			$('#metricsState').textContent='metrics: ok';
		}
		// Suggestions
		function updateOpenBadge(n){ const b=$('#suggestOpenBadge'); if(!b) return; b.textContent='open: '+n; b.style.background = n>0? '#3a2f13':'#1f3b2b'; b.style.color = n>0? '#facc15':'#6ee7b7'; }
		async function refreshSuggestList(){ const r=await api('/suggest/list?limit=50'); const box=$('#suggestList'); if(!box) return; if(!r.items||!r.items.length){ box.innerHTML='<em style="color:#667">Keine Einträge.</em>'; if(typeof r.open==='number') updateOpenBadge(r.open); return;} box.innerHTML=''; r.items.forEach(it=>{ const row=document.createElement('button'); row.className='secondary'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.width='100%'; row.textContent = `${it.id} · ${it.status}`; row.onclick=()=>{ $('#suggestId').value=it.id; loadSuggest(); }; box.appendChild(row); }); if(typeof r.open==='number') updateOpenBadge(r.open); }
		async function genSuggest(){ const goal=$('#suggestGoal').value.trim(); const focus=$('#suggestFocus').value.split(',').map(s=>s.trim()).filter(Boolean); const body={goal, focus_paths:focus.length?focus:undefined}; const r=await api('/suggest/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#suggestOut', fmt(r)); if(r.id) $('#suggestId').value=r.id; refreshSuggestList(); }
		async function autoSuggest(){ const r=await api('/suggest/auto',{method:'POST'}); setText('#suggestOut', fmt(r)); refreshSuggestList(); }
		async function loadSuggest(){ const id=$('#suggestId').value.trim(); if(!id) return; const r=await api('/suggest/review?id='+encodeURIComponent(id)); setText('#suggestOut', fmt(r)); if(r.potential_patches) renderPatch(r.potential_patches); loadImpact(id); }
		async function approveSuggest(){ const id=$('#suggestId').value.trim(); if(!id) return; const body={id, approve:true}; const r=await api('/suggest/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#suggestOut', fmt(r)); refreshSuggestList(); loadImpact(id); }
		async function reviseSuggest(){ const id=$('#suggestId').value.trim(); if(!id) return; const adjustments=$('#suggestAdjust').value; const body={id, approve:false, adjustments}; const r=await api('/suggest/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#suggestOut', fmt(r)); refreshSuggestList(); loadImpact(id); }
		async function refineSuggest(){ const id=$('#suggestId').value.trim(); if(!id) return; const instruction=$('#suggestAdjust').value.trim(); const body={id, instruction:instruction||undefined}; const r=await api('/suggest/llm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#suggestOut', fmt(r)); refreshSuggestList(); loadImpact(id); }
		async function loadImpact(id){ const r=await api('/suggest/impact?id='+encodeURIComponent(id)); if(r && r.impact){ setText('#suggestImpactOut', 'Impact Score: '+r.impact.score+'\n'+(r.impact.rationale||'')); } else { setText('#suggestImpactOut','Impact: -'); } }
		function renderPatch(patches){
			const container=$('#suggestPatchOut'); const nav=$('#suggestPatchNav'); if(!container) return;
			if(!patches||!patches.length){ container.textContent='(no patches)'; if(nav) nav.textContent=''; return; }
			const all=patches.map(p=>p.diff).join('\n\n');
			container.innerHTML=''; nav.innerHTML='';
			const searchVal=($('#patchSearch')?.value||'').trim(); let searchRe=null; if(searchVal){ try{ searchRe=new RegExp(searchVal,'i'); }catch{} }
			let fileIndex=0, hunkIndex=0;
			const lines=all.split(/\n/);
			lines.forEach((raw,i)=>{
				let cls='diff-line diff-context';
				if(raw.startsWith('+++')||raw.startsWith('---')){ return; }
				if(raw.startsWith('diff --git')){ fileIndex++; hunkIndex=0; const a=document.createElement('div'); a.className='diff-line diff-file'; a.id='file-'+fileIndex; a.textContent=raw; container.appendChild(a); const link=document.createElement('a'); link.href='#file-'+fileIndex; link.textContent='Datei '+fileIndex; nav.appendChild(link); return; }
				if(raw.startsWith('@@')){ hunkIndex++; const a=document.createElement('div'); a.className='diff-line diff-hunk'; a.id='hunk-'+fileIndex+'-'+hunkIndex; a.textContent=raw; container.appendChild(a); const link=document.createElement('a'); link.href='#hunk-'+fileIndex+'-'+hunkIndex; link.textContent='Hunk '+fileIndex+':'+hunkIndex; nav.appendChild(link); return; }
				if(raw.startsWith('+')) cls='diff-line diff-add'; else if(raw.startsWith('-')) cls='diff-line diff-del';
				const el=document.createElement('div'); el.className=cls;
				let display=raw; // line numbers extraction
				// simplistic context line numbers not parsed from header; keep placeholder
				el.innerHTML='<span class="ln">'+(i+1).toString().padStart(5,' ')+'</span>'+escapeHtml(display);
				if(searchRe && searchRe.test(raw)){ el.classList.add('highlight'); }
				container.appendChild(el);
			});
		}
		function escapeHtml(s){ return s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
		async function downloadSuggest(){ const id=$('#suggestId').value.trim(); if(!id) return; const r=await api('/suggest/review?id='+encodeURIComponent(id)); const blob=new Blob([JSON.stringify(r,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='suggestion-'+id+'.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); }
		async function copySuggestPatch(){ const pre=$('#suggestPatchOut'); if(!pre) return; const txt=pre.textContent; if(!txt.trim()) return; try{ await navigator.clipboard.writeText(txt);}catch{} }
		// Thought Stream
		function catClass(cat){ switch(cat){ case 'risk':return 'cat-risk'; case 'opportunity':return 'cat-opportunity'; case 'action':return 'cat-action'; case 'system':return 'cat-system'; default:return 'cat-neutral'; } }
		async function refreshThoughts(){ const r=await api('/thought/stream?limit=50'); const pre=$('#thoughtOut'); if(!r.items){ pre.textContent='Keine Gedanken'; return;} pre.textContent=r.items.map(t=>{ const time=new Date(t.ts*1000).toLocaleTimeString(); const cat=t.category||'neutral'; return `${time} · [${cat.toUpperCase()}] ${t.text}`; }).join('\n'); $('#thoughtInfo').textContent = 'total '+r.total; }
		async function genThought(){ const r=await api('/thought/generate',{method:'POST'}); refreshThoughts(); }
		// Events patch already updates open badge & triggers refreshThoughts
		$('#btnThoughtRefresh').onclick=refreshThoughts; $('#btnThoughtGen').onclick=genThought;
		// Bind buttons
		$('#btnMeta').onclick=loadMeta; $('#btnLLM').onclick=loadLLM; $('#btnPlan').onclick=runPlan; $('#btnChat').onclick=runChat; $('#btnEvents').onclick=startEvents; $('#btnMetrics').onclick=loadMetrics; $('#btnIdleState').onclick=loadIdleState; $('#btnIdleTick').onclick=runIdleTick; $('#btnPolicyLoad').onclick=loadPolicy; $('#btnPolicyValidate').onclick=validatePolicy; $('#btnPolicyApply').onclick=applyPolicy; $('#btnSuggestGen').onclick=genSuggest; $('#btnSuggestAuto').onclick=autoSuggest; $('#btnSuggestLoad').onclick=loadSuggest; $('#btnSuggestApprove').onclick=approveSuggest; $('#btnSuggestRevise').onclick=reviseSuggest; $('#btnSuggestRefine').onclick=refineSuggest; $('#btnSuggestList').onclick=refreshSuggestList; $('#btnSuggestDownload').onclick=downloadSuggest; $('#btnSuggestCopyPatch').onclick=copySuggestPatch;
		// Idle
		async function loadIdleState(){ const r=await api('/game/idle/state'); setText('#idleOut', fmt(r)); if(r.state){$('#idleInfo').textContent='tick: '+r.state.tick+' res:'+r.state.resources;} }
		async function runIdleTick(){ const r=await api('/game/idle/tick',{method:'POST'}); setText('#idleOut', fmt(r)); if(r.state){$('#idleInfo').textContent='tick: '+r.state.tick+' res:'+r.state.resources;} }
		// Policy
		async function loadPolicy(){ const r=await api('/policy/current'); setText('#policyOut', fmt(r)); if(r.policy){ $('#policyContent').value = jsyaml.dump(r.policy); $('#policyStatus').textContent='policy: loaded'; setText('#badgePolicy','policy: loaded'); setBadge($('#badgePolicy'), true);} else { setText('#badgePolicy','policy: none'); setBadge($('#badgePolicy'), false);} }
		async function validatePolicy(){
			clearErrors();
			const content=$('#policyContent').value;
			if(!content.trim()){ addError('policyContent','Policy Inhalt leer'); renderErrors(); return; }
			const body={content};
			const r=await api('/policy/dry-run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
			setText('#policyOut', fmt(r));
			if(r.status==='ok'){
				$('#policyStatus').textContent='policy: valid'; setText('#badgePolicy','policy: valid'); setBadge($('#badgePolicy'), true);
			} else if(r.status==='error'){
				addError('policyContent','YAML Fehler: '+r.message); setBadge($('#badgePolicy'), false); $('#policyStatus').textContent='policy: yaml?';
			} else if(r.status==='invalid'){
				addError('policyContent','Validierungsfehler: '+r.message); setBadge($('#badgePolicy'), false); $('#policyStatus').textContent='policy: invalid';
			} else {
				addError('policyContent','Unbekannte Antwort'); setBadge($('#badgePolicy'), false);
			}
			renderErrors();
		}
		async function applyPolicy(){ const content=$('#policyContent').value; const body={content, dry_run:false}; const r=await api('/policy/apply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#policyOut', fmt(r)); $('#policyStatus').textContent = r.status==='applied'? 'policy: applied':'policy: ?'; if(r.status==='applied'){ setText('#badgePolicy','policy: applied'); setBadge($('#badgePolicy'), true);} else { setBadge($('#badgePolicy'), false);} }
		// Memory & quests & thought helpers
		async function refreshMemory(){ const agentId=$('#agentId')? $('#agentId').value.trim():''; const q=agentId? ('?agent_id='+encodeURIComponent(agentId)) : ''; const r=await api('/memory/list'+q); setText('#memoryOut', fmt(r)); $('#memInfo').textContent = r.items? r.items.length+' Einträge':'-'; }
		async function refreshQuestList(){ const r=await api('/quest/list'); setText('#questOut', fmt(r)); }
		$('#btnMemRefresh').onclick=refreshMemory; $('#btnQuestList').onclick=refreshQuestList; $('#btnQuestGen').onclick=genQuest;
		async function genQuest(){ const theme=$('#questTheme').value.trim()||undefined; const difficulty=$('#questDifficulty').value; const body={theme,difficulty}; const r=await api('/quest/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setText('#questOut', fmt(r)); refreshQuestList(); }
		// Init
		buildTabs();
		loadStoredKey(); loadMeta(); loadLLM(); refreshSuggestList(); refreshThoughts(); refreshMemory(); refreshQuestList();
	</script>
</body>
</html>
